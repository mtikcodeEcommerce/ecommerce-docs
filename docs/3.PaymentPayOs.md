# Hướng Dẫn Tích Hợp PayOS trong NestJS

## Giới thiệu

## 1. Setup Tài khoản PayOS
- Làm theo hướng dẫn sau: https://payos.vn/docs/huong-dan-su-dung/tao-tai-khoan-payos
- Kết nối tài khoản ngân hàng: https://payos.vn/docs/huong-dan-su-dung/ket-noi-tai-khoan-ngan-hang
- Tạo kênh thanh toán: https://payos.vn/docs/huong-dan-su-dung/kenh-thu/tao-kenh-thanh-toan
- Sau khi tạo xong kênh thanh toán sẽ có thông tin kết nối API
```.env
PAYOS_CLIENT_ID=
PAYOS_API_KEY=
PAYOS_CHECKSUM_KEY=
PAYOS_RETURN_URL=http://localhost:8080/api/v1/payments/return/payos
PAYOS_CANCEL_URL=http://localhost:8080/api/v1/payments/cancle/payos
```

# 2. Workflow Chi Tiết

## 2.1. Tổng Quan Luồng Thanh Toán

```
CreatePayment → GetPaymentStatus → CheckPayOSMetadata → Update Payment & Order
```

## 2.2. Bước 1: CreatePayment

### Mục đích
Tạo payment record và payment link từ PayOS để khách hàng thanh toán.

### Các bước thực hiện

#### 2.2.1. Validate Order và Permissions
```typescript
const order = await this.orderRepository.findOne({
    where: { id: dto.orderId },
    relations: { orderItems: true, payment: true },
});

// Kiểm tra user có quyền tạo payment cho order này không
if (userRole !== UserRole.ADMIN) {
    const userUuid = await this.getUserUuid(userId);
    if (order.userId !== userUuid) {
        throw new ForbiddenException('Bạn không thể tạo payment cho đơn hàng này');
    }
}
```

#### 2.2.2. Validate Payment Conditions
```typescript
// Kiểm tra order đã có payment hợp lệ chưa
if (
    order.payment &&
    order.payment.status !== PaymentStatusEnum.FAILED &&
    order.payment.status !== PaymentStatusEnum.REFUNDED
) {
    throw new BadRequestException('Đơn hàng đã có payment hợp lệ');
}

// Kiểm tra PayOS đã được cấu hình
if (!this.payosService.isEnabled()) {
    throw new BadRequestException('Hệ thống PayOS chưa được cấu hình');
}

// Đảm bảo inventory còn đủ
await this.ensureInventoryAvailable(order.id);
```

#### 2.2.3. Tạo Payment Link với PayOS
```typescript
const payosOrderCode = this.generatePayosOrderCode(order.id);
const payosResponse = await this.payosService.createPaymentLink({
    orderCode: payosOrderCode,
    amount: Math.round(amount),
    description: `${order.orderNumber}`,
    items: order.orderItems.map((item) => ({
        name: item.productName,
        quantity: item.quantity,
        price: Number(item.price),
    })),
    buyerName: order.customerName,
    buyerEmail: order.customerEmail,
    buyerPhone: order.customerPhone,
    buyerAddress: order.shippingAddress,
    expiredAt: Math.floor(Date.now() / 1000) + 15 * 60, // 15 phút
});
```

**PayOS Response chứa:**
- `paymentLinkId`: Transaction ID
- `checkoutUrl`: URL để khách hàng thanh toán
- `qrCode`: Mã QR để thanh toán
- `bin`, `accountName`, `accountNumber`: Thông tin ngân hàng

#### 2.2.4. Lưu Payment vào Database
```typescript
const payment = order.payment && order.payment.id
    ? this.paymentRepository.merge(order.payment, {
          paymentMethod: dto.paymentMethod,
          amount,
          status: PaymentStatusEnum.PENDING,
          gatewayResponse: JSON.stringify(payosResponse),
          transactionId: payosResponse.paymentLinkId,
          payosOrderCode,
          paymentLinkUrl: payosResponse.checkoutUrl,
          qrCode: payosResponse.qrCode,
          // ... thông tin ngân hàng
      })
    : this.paymentRepository.create({ /* tương tự */ });

const savedPayment = await this.paymentRepository.save(payment);
```

**Trạng thái sau bước này:**
- `payment.status` = `PENDING`
- `order.paymentStatus` = `UNPAID`

#### 2.2.5. Cập nhật Order và Gửi Email
```typescript
await this.orderRepository.update(order.id, {
    paymentStatus: PaymentStatus.UNPAID,
});

await this.sendPaymentCreatedEmail(order, savedPayment);
```

---

## 2.3. Bước 2: GetPaymentStatus

### Mục đích
Kiểm tra trạng thái thanh toán và tự động đồng bộ dữ liệu từ PayOS.

### Các bước thực hiện

#### 2.3.1. Lấy Payment và Validate Permissions
```typescript
const payment = await this.paymentRepository.findOne({
    where: { id: paymentId },
    relations: { order: true },
});

// Kiểm tra quyền truy cập
if (userRole !== UserRole.ADMIN) {
    const userUuid = await this.getUserUuid(userId);
    if (payment.order.userId !== userUuid) {
        throw new ForbiddenException('Bạn không thể truy cập payment này');
    }
}
```

#### 2.3.2. Check PayOS Metadata (Gọi API PayOS)
```typescript
const payosMetadata = payment.payosOrderCode || payment.transactionId
    ? await this.payosService.getPaymentLink(
          payment.payosOrderCode ?? payment.transactionId,
      )
    : null;
```

**PayOS Metadata bao gồm:**
- `status`: PENDING, CANCELLED, UNDERPAID, EXPIRED, PROCESSING, PAID, FAILED
- `transactions[]`: Danh sách giao dịch (chỉ có khi thanh toán thành công)
- Thông tin chi tiết về payment link

#### 2.3.3. Auto Sync nếu có Transactions
```typescript
// Kiểm tra: nếu PayOS có transactions && payment trong DB chưa COMPLETED
if (
    payosMetadata &&
    payment.status !== PaymentStatusEnum.COMPLETED &&
    payosMetadata.transactions &&
    payosMetadata.transactions.length > 0
) {
    // PayOS chỉ tạo transaction khi thanh toán thành công
    await this.syncPaymentStatusFromPayOS(payment, payosMetadata);
}
```

**Logic `syncPaymentStatusFromPayOS`:**
- Cập nhật `payment.status` = `COMPLETED`
- Cập nhật `payment.paidAt` = thời gian từ transaction
- Cập nhật `order.paymentStatus` = `PAID`
- Giảm inventory (reserve → sold)
- Gửi email xác nhận

#### 2.3.4. Reload và Return Payment
```typescript
// Reload payment để lấy dữ liệu mới nhất
const updatedPayment = await this.paymentRepository.findOne({
    where: { id: paymentId },
    relations: { order: true },
});

const enrichedPayment = payment as Payment & {
    payosMetadata?: PaymentLink | null;
};
enrichedPayment.payosMetadata = payosMetadata;

return enrichedPayment;
```

---

## 2.4. Sơ Đồ Trạng Thái

### Payment Status Flow
```
CREATE_PAYMENT
    ↓
PENDING (khách hàng chưa thanh toán)
    ↓
[Khách hàng quét QR/truy cập link và thanh toán]
    ↓
COMPLETED (sau khi sync từ PayOS)
```

### Order Payment Status Flow
```
CREATE_PAYMENT
    ↓
UNPAID
    ↓
[Thanh toán thành công]
    ↓
PAID
```

## 2.5. Best Practices

Frontend nên polling `getPaymentStatus` mỗi 3-5 giây sau khi tạo payment để tự động cập nhật UI khi khách hàng thanh toán thành công.

```typescript
// Frontend example
const pollPaymentStatus = async (paymentId: number) => {
    const interval = setInterval(async () => {
        const payment = await getPaymentStatus(paymentId);
        if (payment.status === 'COMPLETED') {
            clearInterval(interval);
            // Redirect to success page
        }
    }, 3000); // 3 giây
};
```
