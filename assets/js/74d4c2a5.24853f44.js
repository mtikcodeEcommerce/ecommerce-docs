"use strict";(globalThis.webpackChunkecommerce_docs=globalThis.webpackChunkecommerce_docs||[]).push([[815],{3310:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>d,contentTitle:()=>c,default:()=>l,frontMatter:()=>r,metadata:()=>a,toc:()=>o});const a=JSON.parse('{"id":"PaymentPayOs","title":"H\u01b0\u1edbng D\u1eabn T\xedch H\u1ee3p PayOS trong NestJS","description":"Gi\u1edbi thi\u1ec7u","source":"@site/docs/3.PaymentPayOs.md","sourceDirName":".","slug":"/PaymentPayOs","permalink":"/ecommerce-docs/docs/PaymentPayOs","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"H\u01b0\u1edbng d\u1eabn c\xe0i \u0111\u1eb7t ELK Stack v\u1edbi NestJS","permalink":"/ecommerce-docs/docs/SetupElasticsearch"}}');var s=t(4848),i=t(8453);const r={},c="H\u01b0\u1edbng D\u1eabn T\xedch H\u1ee3p PayOS trong NestJS",d={},o=[{value:"Gi\u1edbi thi\u1ec7u",id:"gi\u1edbi-thi\u1ec7u",level:2},{value:"1. Setup T\xe0i kho\u1ea3n PayOS",id:"1-setup-t\xe0i-kho\u1ea3n-payos",level:2},{value:"2.1. T\u1ed5ng Quan Lu\u1ed3ng Thanh To\xe1n",id:"21-t\u1ed5ng-quan-lu\u1ed3ng-thanh-to\xe1n",level:2},{value:"2.2. B\u01b0\u1edbc 1: CreatePayment",id:"22-b\u01b0\u1edbc-1-createpayment",level:2},{value:"M\u1ee5c \u0111\xedch",id:"m\u1ee5c-\u0111\xedch",level:3},{value:"C\xe1c b\u01b0\u1edbc th\u1ef1c hi\u1ec7n",id:"c\xe1c-b\u01b0\u1edbc-th\u1ef1c-hi\u1ec7n",level:3},{value:"2.2.1. Validate Order v\xe0 Permissions",id:"221-validate-order-v\xe0-permissions",level:4},{value:"2.2.2. Validate Payment Conditions",id:"222-validate-payment-conditions",level:4},{value:"2.2.3. T\u1ea1o Payment Link v\u1edbi PayOS",id:"223-t\u1ea1o-payment-link-v\u1edbi-payos",level:4},{value:"2.2.4. L\u01b0u Payment v\xe0o Database",id:"224-l\u01b0u-payment-v\xe0o-database",level:4},{value:"2.2.5. C\u1eadp nh\u1eadt Order v\xe0 G\u1eedi Email",id:"225-c\u1eadp-nh\u1eadt-order-v\xe0-g\u1eedi-email",level:4},{value:"2.3. B\u01b0\u1edbc 2: GetPaymentStatus",id:"23-b\u01b0\u1edbc-2-getpaymentstatus",level:2},{value:"M\u1ee5c \u0111\xedch",id:"m\u1ee5c-\u0111\xedch-1",level:3},{value:"C\xe1c b\u01b0\u1edbc th\u1ef1c hi\u1ec7n",id:"c\xe1c-b\u01b0\u1edbc-th\u1ef1c-hi\u1ec7n-1",level:3},{value:"2.3.1. L\u1ea5y Payment v\xe0 Validate Permissions",id:"231-l\u1ea5y-payment-v\xe0-validate-permissions",level:4},{value:"2.3.2. Check PayOS Metadata (G\u1ecdi API PayOS)",id:"232-check-payos-metadata-g\u1ecdi-api-payos",level:4},{value:"2.3.3. Auto Sync n\u1ebfu c\xf3 Transactions",id:"233-auto-sync-n\u1ebfu-c\xf3-transactions",level:4},{value:"2.3.4. Reload v\xe0 Return Payment",id:"234-reload-v\xe0-return-payment",level:4},{value:"2.4. S\u01a1 \u0110\u1ed3 Tr\u1ea1ng Th\xe1i",id:"24-s\u01a1-\u0111\u1ed3-tr\u1ea1ng-th\xe1i",level:2},{value:"Payment Status Flow",id:"payment-status-flow",level:3},{value:"Order Payment Status Flow",id:"order-payment-status-flow",level:3},{value:"2.5. Best Practices",id:"25-best-practices",level:2}];function h(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"h\u01b0\u1edbng-d\u1eabn-t\xedch-h\u1ee3p-payos-trong-nestjs",children:"H\u01b0\u1edbng D\u1eabn T\xedch H\u1ee3p PayOS trong NestJS"})}),"\n",(0,s.jsx)(e.h2,{id:"gi\u1edbi-thi\u1ec7u",children:"Gi\u1edbi thi\u1ec7u"}),"\n",(0,s.jsx)(e.h2,{id:"1-setup-t\xe0i-kho\u1ea3n-payos",children:"1. Setup T\xe0i kho\u1ea3n PayOS"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["L\xe0m theo h\u01b0\u1edbng d\u1eabn sau: ",(0,s.jsx)(e.a,{href:"https://payos.vn/docs/huong-dan-su-dung/tao-tai-khoan-payos",children:"https://payos.vn/docs/huong-dan-su-dung/tao-tai-khoan-payos"})]}),"\n",(0,s.jsxs)(e.li,{children:["K\u1ebft n\u1ed1i t\xe0i kho\u1ea3n ng\xe2n h\xe0ng: ",(0,s.jsx)(e.a,{href:"https://payos.vn/docs/huong-dan-su-dung/ket-noi-tai-khoan-ngan-hang",children:"https://payos.vn/docs/huong-dan-su-dung/ket-noi-tai-khoan-ngan-hang"})]}),"\n",(0,s.jsxs)(e.li,{children:["T\u1ea1o k\xeanh thanh to\xe1n: ",(0,s.jsx)(e.a,{href:"https://payos.vn/docs/huong-dan-su-dung/kenh-thu/tao-kenh-thanh-toan",children:"https://payos.vn/docs/huong-dan-su-dung/kenh-thu/tao-kenh-thanh-toan"})]}),"\n",(0,s.jsx)(e.li,{children:"Sau khi t\u1ea1o xong k\xeanh thanh to\xe1n s\u1ebd c\xf3 th\xf4ng tin k\u1ebft n\u1ed1i API"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-.env",children:"PAYOS_CLIENT_ID=\nPAYOS_API_KEY=\nPAYOS_CHECKSUM_KEY=\nPAYOS_RETURN_URL=http://localhost:8080/api/v1/payments/return/payos\nPAYOS_CANCEL_URL=http://localhost:8080/api/v1/payments/cancle/payos\n"})}),"\n",(0,s.jsx)(e.h1,{id:"2-workflow-chi-ti\u1ebft",children:"2. Workflow Chi Ti\u1ebft"}),"\n",(0,s.jsx)(e.h2,{id:"21-t\u1ed5ng-quan-lu\u1ed3ng-thanh-to\xe1n",children:"2.1. T\u1ed5ng Quan Lu\u1ed3ng Thanh To\xe1n"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"CreatePayment \u2192 GetPaymentStatus \u2192 CheckPayOSMetadata \u2192 Update Payment & Order\n"})}),"\n",(0,s.jsx)(e.h2,{id:"22-b\u01b0\u1edbc-1-createpayment",children:"2.2. B\u01b0\u1edbc 1: CreatePayment"}),"\n",(0,s.jsx)(e.h3,{id:"m\u1ee5c-\u0111\xedch",children:"M\u1ee5c \u0111\xedch"}),"\n",(0,s.jsx)(e.p,{children:"T\u1ea1o payment record v\xe0 payment link t\u1eeb PayOS \u0111\u1ec3 kh\xe1ch h\xe0ng thanh to\xe1n."}),"\n",(0,s.jsx)(e.h3,{id:"c\xe1c-b\u01b0\u1edbc-th\u1ef1c-hi\u1ec7n",children:"C\xe1c b\u01b0\u1edbc th\u1ef1c hi\u1ec7n"}),"\n",(0,s.jsx)(e.h4,{id:"221-validate-order-v\xe0-permissions",children:"2.2.1. Validate Order v\xe0 Permissions"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"const order = await this.orderRepository.findOne({\n    where: { id: dto.orderId },\n    relations: { orderItems: true, payment: true },\n});\n\n// Ki\u1ec3m tra user c\xf3 quy\u1ec1n t\u1ea1o payment cho order n\xe0y kh\xf4ng\nif (userRole !== UserRole.ADMIN) {\n    const userUuid = await this.getUserUuid(userId);\n    if (order.userId !== userUuid) {\n        throw new ForbiddenException('B\u1ea1n kh\xf4ng th\u1ec3 t\u1ea1o payment cho \u0111\u01a1n h\xe0ng n\xe0y');\n    }\n}\n"})}),"\n",(0,s.jsx)(e.h4,{id:"222-validate-payment-conditions",children:"2.2.2. Validate Payment Conditions"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// Ki\u1ec3m tra order \u0111\xe3 c\xf3 payment h\u1ee3p l\u1ec7 ch\u01b0a\nif (\n    order.payment &&\n    order.payment.status !== PaymentStatusEnum.FAILED &&\n    order.payment.status !== PaymentStatusEnum.REFUNDED\n) {\n    throw new BadRequestException('\u0110\u01a1n h\xe0ng \u0111\xe3 c\xf3 payment h\u1ee3p l\u1ec7');\n}\n\n// Ki\u1ec3m tra PayOS \u0111\xe3 \u0111\u01b0\u1ee3c c\u1ea5u h\xecnh\nif (!this.payosService.isEnabled()) {\n    throw new BadRequestException('H\u1ec7 th\u1ed1ng PayOS ch\u01b0a \u0111\u01b0\u1ee3c c\u1ea5u h\xecnh');\n}\n\n// \u0110\u1ea3m b\u1ea3o inventory c\xf2n \u0111\u1ee7\nawait this.ensureInventoryAvailable(order.id);\n"})}),"\n",(0,s.jsx)(e.h4,{id:"223-t\u1ea1o-payment-link-v\u1edbi-payos",children:"2.2.3. T\u1ea1o Payment Link v\u1edbi PayOS"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"const payosOrderCode = this.generatePayosOrderCode(order.id);\nconst payosResponse = await this.payosService.createPaymentLink({\n    orderCode: payosOrderCode,\n    amount: Math.round(amount),\n    description: `${order.orderNumber}`,\n    items: order.orderItems.map((item) => ({\n        name: item.productName,\n        quantity: item.quantity,\n        price: Number(item.price),\n    })),\n    buyerName: order.customerName,\n    buyerEmail: order.customerEmail,\n    buyerPhone: order.customerPhone,\n    buyerAddress: order.shippingAddress,\n    expiredAt: Math.floor(Date.now() / 1000) + 15 * 60, // 15 ph\xfat\n});\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"PayOS Response ch\u1ee9a:"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"paymentLinkId"}),": Transaction ID"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"checkoutUrl"}),": URL \u0111\u1ec3 kh\xe1ch h\xe0ng thanh to\xe1n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"qrCode"}),": M\xe3 QR \u0111\u1ec3 thanh to\xe1n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"bin"}),", ",(0,s.jsx)(e.code,{children:"accountName"}),", ",(0,s.jsx)(e.code,{children:"accountNumber"}),": Th\xf4ng tin ng\xe2n h\xe0ng"]}),"\n"]}),"\n",(0,s.jsx)(e.h4,{id:"224-l\u01b0u-payment-v\xe0o-database",children:"2.2.4. L\u01b0u Payment v\xe0o Database"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"const payment = order.payment && order.payment.id\n    ? this.paymentRepository.merge(order.payment, {\n          paymentMethod: dto.paymentMethod,\n          amount,\n          status: PaymentStatusEnum.PENDING,\n          gatewayResponse: JSON.stringify(payosResponse),\n          transactionId: payosResponse.paymentLinkId,\n          payosOrderCode,\n          paymentLinkUrl: payosResponse.checkoutUrl,\n          qrCode: payosResponse.qrCode,\n          // ... th\xf4ng tin ng\xe2n h\xe0ng\n      })\n    : this.paymentRepository.create({ /* t\u01b0\u01a1ng t\u1ef1 */ });\n\nconst savedPayment = await this.paymentRepository.save(payment);\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Tr\u1ea1ng th\xe1i sau b\u01b0\u1edbc n\xe0y:"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"payment.status"})," = ",(0,s.jsx)(e.code,{children:"PENDING"})]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"order.paymentStatus"})," = ",(0,s.jsx)(e.code,{children:"UNPAID"})]}),"\n"]}),"\n",(0,s.jsx)(e.h4,{id:"225-c\u1eadp-nh\u1eadt-order-v\xe0-g\u1eedi-email",children:"2.2.5. C\u1eadp nh\u1eadt Order v\xe0 G\u1eedi Email"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"await this.orderRepository.update(order.id, {\n    paymentStatus: PaymentStatus.UNPAID,\n});\n\nawait this.sendPaymentCreatedEmail(order, savedPayment);\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"23-b\u01b0\u1edbc-2-getpaymentstatus",children:"2.3. B\u01b0\u1edbc 2: GetPaymentStatus"}),"\n",(0,s.jsx)(e.h3,{id:"m\u1ee5c-\u0111\xedch-1",children:"M\u1ee5c \u0111\xedch"}),"\n",(0,s.jsx)(e.p,{children:"Ki\u1ec3m tra tr\u1ea1ng th\xe1i thanh to\xe1n v\xe0 t\u1ef1 \u0111\u1ed9ng \u0111\u1ed3ng b\u1ed9 d\u1eef li\u1ec7u t\u1eeb PayOS."}),"\n",(0,s.jsx)(e.h3,{id:"c\xe1c-b\u01b0\u1edbc-th\u1ef1c-hi\u1ec7n-1",children:"C\xe1c b\u01b0\u1edbc th\u1ef1c hi\u1ec7n"}),"\n",(0,s.jsx)(e.h4,{id:"231-l\u1ea5y-payment-v\xe0-validate-permissions",children:"2.3.1. L\u1ea5y Payment v\xe0 Validate Permissions"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"const payment = await this.paymentRepository.findOne({\n    where: { id: paymentId },\n    relations: { order: true },\n});\n\n// Ki\u1ec3m tra quy\u1ec1n truy c\u1eadp\nif (userRole !== UserRole.ADMIN) {\n    const userUuid = await this.getUserUuid(userId);\n    if (payment.order.userId !== userUuid) {\n        throw new ForbiddenException('B\u1ea1n kh\xf4ng th\u1ec3 truy c\u1eadp payment n\xe0y');\n    }\n}\n"})}),"\n",(0,s.jsx)(e.h4,{id:"232-check-payos-metadata-g\u1ecdi-api-payos",children:"2.3.2. Check PayOS Metadata (G\u1ecdi API PayOS)"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"const payosMetadata = payment.payosOrderCode || payment.transactionId\n    ? await this.payosService.getPaymentLink(\n          payment.payosOrderCode ?? payment.transactionId,\n      )\n    : null;\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"PayOS Metadata bao g\u1ed3m:"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"status"}),": PENDING, CANCELLED, UNDERPAID, EXPIRED, PROCESSING, PAID, FAILED"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"transactions[]"}),": Danh s\xe1ch giao d\u1ecbch (ch\u1ec9 c\xf3 khi thanh to\xe1n th\xe0nh c\xf4ng)"]}),"\n",(0,s.jsx)(e.li,{children:"Th\xf4ng tin chi ti\u1ebft v\u1ec1 payment link"}),"\n"]}),"\n",(0,s.jsx)(e.h4,{id:"233-auto-sync-n\u1ebfu-c\xf3-transactions",children:"2.3.3. Auto Sync n\u1ebfu c\xf3 Transactions"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// Ki\u1ec3m tra: n\u1ebfu PayOS c\xf3 transactions && payment trong DB ch\u01b0a COMPLETED\nif (\n    payosMetadata &&\n    payment.status !== PaymentStatusEnum.COMPLETED &&\n    payosMetadata.transactions &&\n    payosMetadata.transactions.length > 0\n) {\n    // PayOS ch\u1ec9 t\u1ea1o transaction khi thanh to\xe1n th\xe0nh c\xf4ng\n    await this.syncPaymentStatusFromPayOS(payment, payosMetadata);\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsxs)(e.strong,{children:["Logic ",(0,s.jsx)(e.code,{children:"syncPaymentStatusFromPayOS"}),":"]})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["C\u1eadp nh\u1eadt ",(0,s.jsx)(e.code,{children:"payment.status"})," = ",(0,s.jsx)(e.code,{children:"COMPLETED"})]}),"\n",(0,s.jsxs)(e.li,{children:["C\u1eadp nh\u1eadt ",(0,s.jsx)(e.code,{children:"payment.paidAt"})," = th\u1eddi gian t\u1eeb transaction"]}),"\n",(0,s.jsxs)(e.li,{children:["C\u1eadp nh\u1eadt ",(0,s.jsx)(e.code,{children:"order.paymentStatus"})," = ",(0,s.jsx)(e.code,{children:"PAID"})]}),"\n",(0,s.jsx)(e.li,{children:"Gi\u1ea3m inventory (reserve \u2192 sold)"}),"\n",(0,s.jsx)(e.li,{children:"G\u1eedi email x\xe1c nh\u1eadn"}),"\n"]}),"\n",(0,s.jsx)(e.h4,{id:"234-reload-v\xe0-return-payment",children:"2.3.4. Reload v\xe0 Return Payment"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// Reload payment \u0111\u1ec3 l\u1ea5y d\u1eef li\u1ec7u m\u1edbi nh\u1ea5t\nconst updatedPayment = await this.paymentRepository.findOne({\n    where: { id: paymentId },\n    relations: { order: true },\n});\n\nconst enrichedPayment = payment as Payment & {\n    payosMetadata?: PaymentLink | null;\n};\nenrichedPayment.payosMetadata = payosMetadata;\n\nreturn enrichedPayment;\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"24-s\u01a1-\u0111\u1ed3-tr\u1ea1ng-th\xe1i",children:"2.4. S\u01a1 \u0110\u1ed3 Tr\u1ea1ng Th\xe1i"}),"\n",(0,s.jsx)(e.h3,{id:"payment-status-flow",children:"Payment Status Flow"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"CREATE_PAYMENT\n    \u2193\nPENDING (kh\xe1ch h\xe0ng ch\u01b0a thanh to\xe1n)\n    \u2193\n[Kh\xe1ch h\xe0ng qu\xe9t QR/truy c\u1eadp link v\xe0 thanh to\xe1n]\n    \u2193\nCOMPLETED (sau khi sync t\u1eeb PayOS)\n"})}),"\n",(0,s.jsx)(e.h3,{id:"order-payment-status-flow",children:"Order Payment Status Flow"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"CREATE_PAYMENT\n    \u2193\nUNPAID\n    \u2193\n[Thanh to\xe1n th\xe0nh c\xf4ng]\n    \u2193\nPAID\n"})}),"\n",(0,s.jsx)(e.h2,{id:"25-best-practices",children:"2.5. Best Practices"}),"\n",(0,s.jsxs)(e.p,{children:["Frontend n\xean polling ",(0,s.jsx)(e.code,{children:"getPaymentStatus"})," m\u1ed7i 3-5 gi\xe2y sau khi t\u1ea1o payment \u0111\u1ec3 t\u1ef1 \u0111\u1ed9ng c\u1eadp nh\u1eadt UI khi kh\xe1ch h\xe0ng thanh to\xe1n th\xe0nh c\xf4ng."]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// Frontend example\nconst pollPaymentStatus = async (paymentId: number) => {\n    const interval = setInterval(async () => {\n        const payment = await getPaymentStatus(paymentId);\n        if (payment.status === 'COMPLETED') {\n            clearInterval(interval);\n            // Redirect to success page\n        }\n    }, 3000); // 3 gi\xe2y\n};\n"})})]})}function l(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(h,{...n})}):h(n)}},8453:(n,e,t)=>{t.d(e,{R:()=>r,x:()=>c});var a=t(6540);const s={},i=a.createContext(s);function r(n){const e=a.useContext(i);return a.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:r(n.components),a.createElement(i.Provider,{value:e},n.children)}}}]);