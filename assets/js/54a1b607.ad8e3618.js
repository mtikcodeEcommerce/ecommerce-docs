"use strict";(globalThis.webpackChunkecommerce_docs=globalThis.webpackChunkecommerce_docs||[]).push([[89],{2423:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>o,contentTitle:()=>c,default:()=>d,frontMatter:()=>l,metadata:()=>t,toc:()=>a});const t=JSON.parse('{"id":"SetupElasticsearch","title":"H\u01b0\u1edbng d\u1eabn c\xe0i \u0111\u1eb7t ELK Stack v\u1edbi NestJS","description":"Gi\u1edbi thi\u1ec7u","source":"@site/docs/SetupElasticsearch.md","sourceDirName":".","slug":"/SetupElasticsearch","permalink":"/ecommerce-docs/docs/SetupElasticsearch","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Setup Authorization","permalink":"/ecommerce-docs/docs/SetupAuth"}}');var r=s(4848),i=s(8453);const l={},c="H\u01b0\u1edbng d\u1eabn c\xe0i \u0111\u1eb7t ELK Stack v\u1edbi NestJS",o={},a=[{value:"Gi\u1edbi thi\u1ec7u",id:"gi\u1edbi-thi\u1ec7u",level:2},{value:"1. C\xe0i \u0111\u1eb7t ELK b\u1eb1ng Docker",id:"1-c\xe0i-\u0111\u1eb7t-elk-b\u1eb1ng-docker",level:2},{value:"1.1. T\u1ea1o file docker-compose.yml",id:"11-t\u1ea1o-file-docker-composeyml",level:3},{value:"1.2. C\u1ea5u h\xecnh Logstash",id:"12-c\u1ea5u-h\xecnh-logstash",level:3},{value:"Option 1: Nh\u1eadn logs t\u1eeb \u1ee9ng d\u1ee5ng (qua TCP)",id:"option-1-nh\u1eadn-logs-t\u1eeb-\u1ee9ng-d\u1ee5ng-qua-tcp",level:4},{value:"Option 2: L\u1ea5y d\u1eef li\u1ec7u t\u1eeb PostgreSQL",id:"option-2-l\u1ea5y-d\u1eef-li\u1ec7u-t\u1eeb-postgresql",level:4},{value:"1.3. Kh\u1edfi \u0111\u1ed9ng",id:"13-kh\u1edfi-\u0111\u1ed9ng",level:3},{value:"1.4. Ki\u1ec3m tra",id:"14-ki\u1ec3m-tra",level:3},{value:"2. T\xedch h\u1ee3p v\xe0o NestJS",id:"2-t\xedch-h\u1ee3p-v\xe0o-nestjs",level:2},{value:"2.1. C\xe0i \u0111\u1eb7t package",id:"21-c\xe0i-\u0111\u1eb7t-package",level:3},{value:"2.2. C\u1ea5u h\xecnh Module",id:"22-c\u1ea5u-h\xecnh-module",level:3},{value:"2.3. S\u1eed d\u1ee5ng trong Service",id:"23-s\u1eed-d\u1ee5ng-trong-service",level:3},{value:"2.4. T\xedch h\u1ee3p Logger v\u1edbi Logstash",id:"24-t\xedch-h\u1ee3p-logger-v\u1edbi-logstash",level:3},{value:"3. Xem d\u1eef li\u1ec7u tr\xean Kibana",id:"3-xem-d\u1eef-li\u1ec7u-tr\xean-kibana",level:2},{value:"3.1. Truy c\u1eadp Kibana",id:"31-truy-c\u1eadp-kibana",level:3},{value:"3.2. T\u1ea1o Index Pattern",id:"32-t\u1ea1o-index-pattern",level:3},{value:"3.3. Xem d\u1eef li\u1ec7u",id:"33-xem-d\u1eef-li\u1ec7u",level:3},{value:"3.4. L\u1ecdc d\u1eef li\u1ec7u",id:"34-l\u1ecdc-d\u1eef-li\u1ec7u",level:3},{value:"4. Testing",id:"4-testing",level:2},{value:"4.1. Test Elasticsearch",id:"41-test-elasticsearch",level:3},{value:"4.2. Test Logstash",id:"42-test-logstash",level:3},{value:"4.3. Test trong NestJS",id:"43-test-trong-nestjs",level:3},{value:"5. Workflow t\u1ed5ng quan",id:"5-workflow-t\u1ed5ng-quan",level:2},{value:"Lu\u1ed3ng d\u1eef li\u1ec7u t\u1eeb PostgreSQL \u2192 Elasticsearch \u2192 Kibana",id:"lu\u1ed3ng-d\u1eef-li\u1ec7u-t\u1eeb-postgresql--elasticsearch--kibana",level:3},{value:"C\xe1c b\u01b0\u1edbc tri\u1ec3n khai nhanh",id:"c\xe1c-b\u01b0\u1edbc-tri\u1ec3n-khai-nhanh",level:3}];function h(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"h\u01b0\u1edbng-d\u1eabn-c\xe0i-\u0111\u1eb7t-elk-stack-v\u1edbi-nestjs",children:"H\u01b0\u1edbng d\u1eabn c\xe0i \u0111\u1eb7t ELK Stack v\u1edbi NestJS"})}),"\n",(0,r.jsx)(e.h2,{id:"gi\u1edbi-thi\u1ec7u",children:"Gi\u1edbi thi\u1ec7u"}),"\n",(0,r.jsx)(e.p,{children:"ELK Stack g\u1ed3m 3 th\xe0nh ph\u1ea7n:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Elasticsearch"}),": L\u01b0u tr\u1eef v\xe0 t\xecm ki\u1ebfm d\u1eef li\u1ec7u"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Logstash"}),": Thu th\u1eadp v\xe0 x\u1eed l\xfd logs"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Kibana"}),": Xem v\xe0 ph\xe2n t\xedch d\u1eef li\u1ec7u tr\u1ef1c quan"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"1-c\xe0i-\u0111\u1eb7t-elk-b\u1eb1ng-docker",children:"1. C\xe0i \u0111\u1eb7t ELK b\u1eb1ng Docker"}),"\n",(0,r.jsx)(e.h3,{id:"11-t\u1ea1o-file-docker-composeyml",children:"1.1. T\u1ea1o file docker-compose.yml"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:'version: \'3.8\'\n\nservices:\n  elasticsearch:\n    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0\n    container_name: elasticsearch\n    environment:\n      - discovery.type=single-node\n      - ES_JAVA_OPTS=-Xms512m -Xmx512m\n      - xpack.security.enabled=false\n    ports:\n      - "9200:9200"\n    volumes:\n      - elasticsearch_data:/usr/share/elasticsearch/data\n    networks:\n      - elk\n\n  logstash:\n    image: docker.elastic.co/logstash/logstash:8.11.0\n    container_name: logstash\n    volumes:\n      - ./logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml\n      - ./logstash/pipeline:/usr/share/logstash/pipeline\n    ports:\n      - "5000:5000"\n    networks:\n      - elk\n    depends_on:\n      - elasticsearch\n\n  kibana:\n    image: docker.elastic.co/kibana/kibana:8.11.0\n    container_name: kibana\n    ports:\n      - "5601:5601"\n    environment:\n      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200\n    networks:\n      - elk\n    depends_on:\n      - elasticsearch\n\nnetworks:\n  elk:\n    driver: bridge\n\nvolumes:\n  elasticsearch_data:\n'})}),"\n",(0,r.jsx)(e.h3,{id:"12-c\u1ea5u-h\xecnh-logstash",children:"1.2. C\u1ea5u h\xecnh Logstash"}),"\n",(0,r.jsx)(e.p,{children:"T\u1ea1o th\u01b0 m\u1ee5c v\xe0 file c\u1ea5u h\xecnh:"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["File ",(0,r.jsx)(e.code,{children:"logstash/config/logstash.yml"}),":"]})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:'http.host: "0.0.0.0"\nxpack.monitoring.elasticsearch.hosts: ["http://elasticsearch:9200"]\n'})}),"\n",(0,r.jsx)(e.h4,{id:"option-1-nh\u1eadn-logs-t\u1eeb-\u1ee9ng-d\u1ee5ng-qua-tcp",children:"Option 1: Nh\u1eadn logs t\u1eeb \u1ee9ng d\u1ee5ng (qua TCP)"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["File ",(0,r.jsx)(e.code,{children:"logstash/pipeline/logstash.conf"}),":"]})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-conf",children:'input {\n  tcp {\n    port => 5000\n    codec => json\n  }\n}\n\nfilter {\n  mutate {\n    add_field => { "service" => "nestjs-app" }\n  }\n}\n\noutput {\n  elasticsearch {\n    hosts => ["http://elasticsearch:9200"]\n    index => "nestjs-logs-%{+YYYY.MM.dd}"\n  }\n  stdout { codec => rubydebug }\n}\n'})}),"\n",(0,r.jsx)(e.h4,{id:"option-2-l\u1ea5y-d\u1eef-li\u1ec7u-t\u1eeb-postgresql",children:"Option 2: L\u1ea5y d\u1eef li\u1ec7u t\u1eeb PostgreSQL"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"C\xe0i \u0111\u1eb7t JDBC driver:"})}),"\n",(0,r.jsxs)(e.p,{children:["T\u1ea3i PostgreSQL JDBC driver v\xe0 \u0111\u1eb7t v\xe0o ",(0,r.jsx)(e.code,{children:"logstash/drivers/"}),":"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"mkdir -p logstash/drivers\ncd logstash/drivers\nwget https://jdbc.postgresql.org/download/postgresql-42.6.0.jar\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["File ",(0,r.jsx)(e.code,{children:"logstash/pipeline/postgres.conf"}),":"]})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-conf",children:'input {\n  jdbc {\n    jdbc_driver_library => "/usr/share/logstash/drivers/postgresql-42.6.0.jar"\n    jdbc_driver_class => "org.postgresql.Driver"\n    jdbc_connection_string => "jdbc:postgresql://{host}:{port}/postgres"\n    jdbc_user => "username"\n    jdbc_password => "password"\n    \n    # Query \u0111\u1ec3 l\u1ea5y d\u1eef li\u1ec7u products (lo\u1ea1i b\u1ecf soft-deleted)\n    statement => "\n      SELECT \n        id, category_id, name, slug, short_description, description,\n        price, compare_at_price, stock_quantity, sku,\n        is_active, is_featured, view_count,\n        rating_average, review_count,\n        created_at, updated_at\n      FROM products \n      WHERE deleted_at IS NULL \n        AND updated_at > :sql_last_value \n      ORDER BY updated_at\n    "\n    \n    # S\u1eed d\u1ee5ng updated_at \u0111\u1ec3 tracking\n    use_column_value => true\n    tracking_column => "updated_at"\n    tracking_column_type => "timestamp"\n    \n    # Ch\u1ea1y m\u1ed7i 30 gi\xe2y\n    schedule => "*/30 * * * * *"\n  }\n}\n\nfilter {\n  # Chuy\u1ec3n \u0111\u1ed5i ki\u1ec3u d\u1eef li\u1ec7u\n  mutate {\n    convert => {\n      "id" => "integer"\n      "category_id" => "integer"\n      "price" => "float"\n      "compare_at_price" => "float"\n      "stock_quantity" => "integer"\n      "view_count" => "integer"\n      "rating_average" => "float"\n      "review_count" => "integer"\n      "is_active" => "boolean"\n      "is_featured" => "boolean"\n    }\n    \n    # X\xf3a c\xe1c field kh\xf4ng c\u1ea7n thi\u1ebft\n    remove_field => ["@version", "@timestamp"]\n  }\n  \n  # Th\xeam tr\u1ea1ng th\xe1i stock\n  if [stock_quantity] > 0 {\n    mutate {\n      add_field => { "stock_status" => "in_stock" }\n    }\n  } else {\n    mutate {\n      add_field => { "stock_status" => "out_of_stock" }\n    }\n  }\n}\n\noutput {\n  elasticsearch {\n    hosts => ["http://elasticsearch:9200"]\n    index => "products"\n    document_id => "%{id}"\n    \n    # Mapping template cho Elasticsearch\n    template => "/usr/share/logstash/templates/products-template.json"\n    template_name => "products"\n    template_overwrite => true\n    template_api => "composable"\n  }\n  \n  stdout { codec => rubydebug }\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["File ",(0,r.jsx)(e.code,{children:"logstash/templates/products-template.json"}),":"]})}),"\n",(0,r.jsx)(e.p,{children:"T\u1ea1o file template \u0111\u1ec3 \u0111\u1ecbnh ngh\u0129a mapping cho Elasticsearch:"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-json",children:'{\n  "index_patterns": ["products*"],\n  "template": {\n    "settings": {\n      "number_of_shards": 1,\n      "number_of_replicas": 0\n    },\n    "mappings": {\n      "properties": {\n        "id": { "type": "integer" },\n        "category_id": { "type": "integer" },\n        "name": { \n          "type": "text",\n          "fields": {\n            "keyword": { "type": "keyword" }\n          }\n        },\n        "slug": { "type": "keyword" },\n        "short_description": { "type": "text" },\n        "description": { "type": "text" },\n        "price": { "type": "float" },\n        "compare_at_price": { "type": "float" },\n        "stock_quantity": { "type": "integer" },\n        "stock_status": { "type": "keyword" },\n        "sku": { "type": "keyword" },\n        "is_active": { "type": "boolean" },\n        "is_featured": { "type": "boolean" },\n        "view_count": { "type": "integer" },\n        "rating_average": { "type": "float" },\n        "review_count": { "type": "integer" },\n        "created_at": { "type": "date" },\n        "updated_at": { "type": "date" }\n      }\n    }\n  },\n  "priority": 200,\n  "version": 1\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"C\u1eadp nh\u1eadt docker-compose.yml \u0111\u1ec3 mount driver v\xe0 template:"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:'logstash:\n  image: docker.elastic.co/logstash/logstash:8.11.0\n  container_name: logstash\n  volumes:\n    - ./logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml\n    - ./logstash/pipeline:/usr/share/logstash/pipeline\n    - ./logstash/drivers:/usr/share/logstash/drivers\n    - ./logstash/templates:/usr/share/logstash/templates\n  ports:\n    - "5000:5000"\n  networks:\n    - elk\n  depends_on:\n    - elasticsearch\n'})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"C\u1ea5u tr\xfac th\u01b0 m\u1ee5c:"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"logstash/\n\u251c\u2500\u2500 config/\n\u2502   \u2514\u2500\u2500 logstash.yml\n\u251c\u2500\u2500 pipeline/\n\u2502   \u2514\u2500\u2500 postgres.conf\n\u251c\u2500\u2500 drivers/\n\u2502   \u2514\u2500\u2500 postgresql-42.7.1.jar\n\u2514\u2500\u2500 templates/\n    \u2514\u2500\u2500 products-template.json\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Gi\u1ea3i th\xedch c\u1ea5u h\xecnh:"})}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Query SQL:"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["L\u1ea5y t\u1ea5t c\u1ea3 tr\u01b0\u1eddng t\u1eeb b\u1ea3ng ",(0,r.jsx)(e.code,{children:"products"})]}),"\n",(0,r.jsxs)(e.li,{children:["Lo\u1ea1i b\u1ecf c\xe1c b\u1ea3n ghi \u0111\xe3 soft-delete (",(0,r.jsx)(e.code,{children:"deleted_at IS NULL"}),")"]}),"\n",(0,r.jsxs)(e.li,{children:["Ch\u1ec9 l\u1ea5y b\u1ea3n ghi m\u1edbi h\u01a1n l\u1ea7n ch\u1ea1y tr\u01b0\u1edbc (",(0,r.jsx)(e.code,{children:"updated_at > :sql_last_value"}),")"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Filter x\u1eed l\xfd:"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Chuy\u1ec3n \u0111\u1ed5i ki\u1ec3u d\u1eef li\u1ec7u ph\xf9 h\u1ee3p (integer, float, boolean)"}),"\n",(0,r.jsxs)(e.li,{children:["Th\xeam ",(0,r.jsx)(e.code,{children:"stock_status"})," d\u1ef1a tr\xean ",(0,r.jsx)(e.code,{children:"stock_quantity"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Mapping Template:"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u0110\u1ecbnh ngh\u0129a ki\u1ec3u d\u1eef li\u1ec7u cho m\u1ed7i field trong Elasticsearch"}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"name"})," c\xf3 c\u1ea3 text (\u0111\u1ec3 search) v\xe0 keyword (\u0111\u1ec3 filter/sort)"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"slug"}),", ",(0,r.jsx)(e.code,{children:"sku"})," l\xe0 keyword (exact match)"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Schedule:"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"*/30 * * * * *"})," = ch\u1ea1y m\u1ed7i 30 gi\xe2y"]}),"\n",(0,r.jsxs)(e.li,{children:["C\xf3 th\u1ec3 \u0111i\u1ec1u ch\u1ec9nh: ",(0,r.jsx)(e.code,{children:"*/1 * * * *"})," = m\u1ed7i 1 ph\xfat, ",(0,r.jsx)(e.code,{children:"*/5 * * * *"})," = m\u1ed7i 5 ph\xfat"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"L\u01b0u \xfd quan tr\u1ecdng:"})}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Soft Delete"}),": Query \u0111\xe3 lo\u1ea1i b\u1ecf c\xe1c b\u1ea3n ghi c\xf3 ",(0,r.jsx)(e.code,{children:"deleted_at"})," kh\xf4ng NULL (soft-deleted records)"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Tracking state"}),": Logstash t\u1ef1 \u0111\u1ed9ng l\u01b0u tr\u1ea1ng th\xe1i trong file ",(0,r.jsx)(e.code,{children:".logstash_jdbc_last_run"}),", kh\xf4ng lo b\u1ecb tr\xf9ng d\u1eef li\u1ec7u"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Auto-sync"}),": M\u1ed7i 30 gi\xe2y, Logstash s\u1ebd t\u1ef1 \u0111\u1ed9ng check v\xe0 \u0111\u1ed3ng b\u1ed9 c\xe1c b\u1ea3n ghi m\u1edbi/c\u1eadp nh\u1eadt t\u1eeb PostgreSQL"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"T\xednh n\u0103ng n\xe2ng cao"}),":"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"T\u1ef1 \u0111\u1ed9ng ph\xe2n lo\u1ea1i tr\u1ea1ng th\xe1i kho (in_stock/out_of_stock)"}),"\n",(0,r.jsx)(e.li,{children:"Mapping t\u1ed1i \u01b0u cho t\xecm ki\u1ebfm full-text v\xe0 filter"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u0110\u1ed3ng b\u1ed9 nhi\u1ec1u b\u1ea3ng"}),": T\u1ea1o th\xeam file ",(0,r.jsx)(e.code,{children:".conf"})," trong ",(0,r.jsx)(e.code,{children:"logstash/pipeline/"})," cho m\u1ed7i b\u1ea3ng (categories, users, orders...)"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"13-kh\u1edfi-\u0111\u1ed9ng",children:"1.3. Kh\u1edfi \u0111\u1ed9ng"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# Kh\u1edfi \u0111\u1ed9ng\ndocker-compose up -d\n\n# Ki\u1ec3m tra\ndocker-compose ps\n\n# Xem logs\ndocker-compose logs -f\n"})}),"\n",(0,r.jsx)(e.h3,{id:"14-ki\u1ec3m-tra",children:"1.4. Ki\u1ec3m tra"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["Elasticsearch: ",(0,r.jsx)(e.a,{href:"http://localhost:9200",children:"http://localhost:9200"})]}),"\n",(0,r.jsxs)(e.li,{children:["Kibana: ",(0,r.jsx)(e.a,{href:"http://localhost:5601",children:"http://localhost:5601"})]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"curl http://localhost:9200\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"2-t\xedch-h\u1ee3p-v\xe0o-nestjs",children:"2. T\xedch h\u1ee3p v\xe0o NestJS"}),"\n",(0,r.jsx)(e.h3,{id:"21-c\xe0i-\u0111\u1eb7t-package",children:"2.1. C\xe0i \u0111\u1eb7t package"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"npm install @nestjs/elasticsearch\n"})}),"\n",(0,r.jsx)(e.h3,{id:"22-c\u1ea5u-h\xecnh-module",children:"2.2. C\u1ea5u h\xecnh Module"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["File ",(0,r.jsx)(e.code,{children:".env"}),":"]})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-env",children:"ELASTICSEARCH_NODE=http://localhost:9200\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["File ",(0,r.jsx)(e.code,{children:"src/elasticsearch/elasticsearch.module.ts"}),":"]})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-typescript",children:"import { Module } from '@nestjs/common';\nimport { ElasticsearchModule as NestElasticsearchModule } from '@nestjs/elasticsearch';\nimport { ConfigModule, ConfigService } from '@nestjs/config';\n\n@Module({\n  imports: [\n    NestElasticsearchModule.registerAsync({\n      imports: [ConfigModule],\n      useFactory: (config: ConfigService) => ({\n        node: config.get('ELASTICSEARCH_NODE'),\n      }),\n      inject: [ConfigService],\n    }),\n  ],\n  exports: [NestElasticsearchModule],\n})\nexport class ElasticsearchModule {}\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["File ",(0,r.jsx)(e.code,{children:"src/app.module.ts"}),":"]})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-typescript",children:"import { Module } from '@nestjs/common';\nimport { ConfigModule } from '@nestjs/config';\nimport { ElasticsearchModule } from './elasticsearch/elasticsearch.module';\n\n@Module({\n  imports: [\n    ConfigModule.forRoot({ isGlobal: true }),\n    ElasticsearchModule,\n  ],\n})\nexport class AppModule {}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"23-s\u1eed-d\u1ee5ng-trong-service",children:"2.3. S\u1eed d\u1ee5ng trong Service"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["V\xed d\u1ee5: ",(0,r.jsx)(e.code,{children:"src/products/products.service.ts"}),":"]})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-typescript",children:"import { Injectable } from '@nestjs/common';\nimport { ElasticsearchService } from '@nestjs/elasticsearch';\n\n@Injectable()\nexport class ProductsService {\n  constructor(private readonly esService: ElasticsearchService) {}\n\n  // T\xecm ki\u1ebfm s\u1ea3n ph\u1ea9m theo t\xean/m\xf4 t\u1ea3\n  async searchProducts(keyword: string, page = 1, limit = 20) {\n    const { hits } = await this.esService.search({\n      index: 'products',\n      from: (page - 1) * limit,\n      size: limit,\n      body: {\n        query: {\n          bool: {\n            must: [\n              {\n                multi_match: {\n                  query: keyword,\n                  fields: ['name^2', 'description', 'short_description'],\n                  fuzziness: 'AUTO'\n                }\n              },\n              { term: { is_active: true } }\n            ]\n          }\n        },\n        sort: [{ rating_average: 'desc' }, { view_count: 'desc' }]\n      }\n    });\n    \n    return {\n      data: hits.hits.map(hit => hit._source),\n      total: hits.total.value,\n      page,\n      limit\n    };\n  }\n\n  // L\u1ea5y s\u1ea3n ph\u1ea9m theo category\n  async getProductsByCategory(categoryId: number, page = 1, limit = 20) {\n    const { hits } = await this.esService.search({\n      index: 'products',\n      from: (page - 1) * limit,\n      size: limit,\n      body: {\n        query: {\n          bool: {\n            must: [\n              { term: { category_id: categoryId } },\n              { term: { is_active: true } }\n            ]\n          }\n        },\n        sort: [{ created_at: 'desc' }]\n      }\n    });\n    \n    return hits.hits.map(hit => hit._source);\n  }\n\n  // T\xecm s\u1ea3n ph\u1ea9m theo kho\u1ea3ng gi\xe1\n  async getProductsByPriceRange(minPrice: number, maxPrice: number) {\n    const { hits } = await this.esService.search({\n      index: 'products',\n      body: {\n        query: {\n          bool: {\n            must: [\n              { range: { price: { gte: minPrice, lte: maxPrice } } },\n              { term: { is_active: true } }\n            ]\n          }\n        }\n      }\n    });\n    \n    return hits.hits.map(hit => hit._source);\n  }\n\n  // L\u1ea5y s\u1ea3n ph\u1ea9m n\u1ed5i b\u1eadt\n  async getFeaturedProducts(limit = 10) {\n    const { hits } = await this.esService.search({\n      index: 'products',\n      size: limit,\n      body: {\n        query: {\n          bool: {\n            must: [\n              { term: { is_featured: true } },\n              { term: { is_active: true } }\n            ]\n          }\n        },\n        sort: [{ view_count: 'desc' }]\n      }\n    });\n    \n    return hits.hits.map(hit => hit._source);\n  }\n}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"24-t\xedch-h\u1ee3p-logger-v\u1edbi-logstash",children:"2.4. T\xedch h\u1ee3p Logger v\u1edbi Logstash"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"C\xe0i \u0111\u1eb7t:"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"npm install winston winston-logstash\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["File ",(0,r.jsx)(e.code,{children:"src/logger/winston.config.ts"}),":"]})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-typescript",children:"import * as winston from 'winston';\nimport LogstashTransport from 'winston-logstash/lib/winston-logstash-latest';\n\nexport const logger = winston.createLogger({\n  transports: [\n    new winston.transports.Console(),\n    new LogstashTransport({\n      port: 5000,\n      host: 'localhost',\n    }),\n  ],\n});\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"S\u1eed d\u1ee5ng trong code:"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-typescript",children:"import { logger } from './logger/winston.config';\n\nlogger.info('User logged in', { userId: 123 });\nlogger.error('Payment failed', { orderId: 456, error: 'timeout' });\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"3-xem-d\u1eef-li\u1ec7u-tr\xean-kibana",children:"3. Xem d\u1eef li\u1ec7u tr\xean Kibana"}),"\n",(0,r.jsx)(e.h3,{id:"31-truy-c\u1eadp-kibana",children:"3.1. Truy c\u1eadp Kibana"}),"\n",(0,r.jsxs)(e.p,{children:["M\u1edf tr\xecnh duy\u1ec7t: ",(0,r.jsx)(e.a,{href:"http://localhost:5601",children:"http://localhost:5601"})]}),"\n",(0,r.jsx)(e.h3,{id:"32-t\u1ea1o-index-pattern",children:"3.2. T\u1ea1o Index Pattern"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Cho logs t\u1eeb \u1ee9ng d\u1ee5ng:"})}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["V\xe0o ",(0,r.jsx)(e.strong,{children:"Management"})," \u2192 ",(0,r.jsx)(e.strong,{children:"Stack Management"})," \u2192 ",(0,r.jsx)(e.strong,{children:"Index Patterns"})]}),"\n",(0,r.jsxs)(e.li,{children:["Click ",(0,r.jsx)(e.strong,{children:"Create index pattern"})]}),"\n",(0,r.jsxs)(e.li,{children:["Nh\u1eadp: ",(0,r.jsx)(e.code,{children:"nestjs-logs-*"})]}),"\n",(0,r.jsxs)(e.li,{children:["Ch\u1ecdn Time field: ",(0,r.jsx)(e.code,{children:"@timestamp"})]}),"\n",(0,r.jsxs)(e.li,{children:["Click ",(0,r.jsx)(e.strong,{children:"Create"})]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Cho d\u1eef li\u1ec7u t\u1eeb PostgreSQL:"})}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"T\u1ea1o index pattern m\u1edbi"}),"\n",(0,r.jsxs)(e.li,{children:["Nh\u1eadp: ",(0,r.jsx)(e.code,{children:"products"})," (ho\u1eb7c ",(0,r.jsx)(e.code,{children:"users"}),", t\xf9y table b\u1ea1n \u0111\u1ed3ng b\u1ed9)"]}),"\n",(0,r.jsxs)(e.li,{children:["Ch\u1ecdn Time field: ",(0,r.jsx)(e.code,{children:"updated_at"})," ho\u1eb7c skip n\u1ebfu kh\xf4ng c\xf3"]}),"\n",(0,r.jsxs)(e.li,{children:["Click ",(0,r.jsx)(e.strong,{children:"Create"})]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"33-xem-d\u1eef-li\u1ec7u",children:"3.3. Xem d\u1eef li\u1ec7u"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Xem Logs:"})}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["V\xe0o menu ",(0,r.jsx)(e.strong,{children:"Discover"})]}),"\n",(0,r.jsxs)(e.li,{children:["Ch\u1ecdn index pattern ",(0,r.jsx)(e.code,{children:"nestjs-logs-*"})]}),"\n",(0,r.jsx)(e.li,{children:"B\u1ea1n s\u1ebd th\u1ea5y t\u1ea5t c\u1ea3 logs t\u1eeb \u1ee9ng d\u1ee5ng"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Xem d\u1eef li\u1ec7u PostgreSQL:"})}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["V\xe0o menu ",(0,r.jsx)(e.strong,{children:"Discover"})]}),"\n",(0,r.jsxs)(e.li,{children:["Ch\u1ecdn index pattern ",(0,r.jsx)(e.code,{children:"products"})]}),"\n",(0,r.jsx)(e.li,{children:"B\u1ea1n s\u1ebd th\u1ea5y t\u1ea5t c\u1ea3 d\u1eef li\u1ec7u t\u1eeb b\u1ea3ng PostgreSQL \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9"}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"34-l\u1ecdc-d\u1eef-li\u1ec7u",children:"3.4. L\u1ecdc d\u1eef li\u1ec7u"}),"\n",(0,r.jsx)(e.p,{children:"S\u1eed d\u1ee5ng KQL (Kibana Query Language):"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"L\u1ecdc logs:"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:'level: "error"\nservice: "nestjs-app"\nuserId: 123\n'})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"L\u1ecdc d\u1eef li\u1ec7u Products t\u1eeb PostgreSQL:"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:'# T\xecm s\u1ea3n ph\u1ea9m theo t\xean\nname: *laptop*\n\n# L\u1ecdc theo category\ncategory_id: 5\n\n# L\u1ecdc theo gi\xe1\nprice >= 100 AND price <= 500\n\n# Ch\u1ec9 s\u1ea3n ph\u1ea9m \u0111ang active\nis_active: true\n\n# S\u1ea3n ph\u1ea9m n\u1ed5i b\u1eadt\nis_featured: true\n\n# S\u1ea3n ph\u1ea9m c\xf2n h\xe0ng\nstock_status: "in_stock"\n\n# Rating cao\nrating_average >= 4.0\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"4-testing",children:"4. Testing"}),"\n",(0,r.jsx)(e.h3,{id:"41-test-elasticsearch",children:"4.1. Test Elasticsearch"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# Ki\u1ec3m tra health\ncurl http://localhost:9200/_cluster/health\n\n# Xem indices\ncurl http://localhost:9200/_cat/indices\n\n# T\xecm ki\u1ebfm\ncurl http://localhost:9200/products/_search?q=name:laptop\n"})}),"\n",(0,r.jsx)(e.h3,{id:"42-test-logstash",children:"4.2. Test Logstash"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Test nh\u1eadn logs qua TCP:"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:'# G\u1eedi test log (Linux/Mac)\necho \'{"message":"test","level":"info"}\' | nc localhost 5000\n'})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Test \u0111\u1ed3ng b\u1ed9 t\u1eeb PostgreSQL:"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# Ki\u1ec3m tra Logstash logs \u0111\u1ec3 xem c\xf3 l\u1ed7i kh\xf4ng\ndocker logs logstash -f\n\n# Ki\u1ec3m tra d\u1eef li\u1ec7u \u0111\xe3 \u0111\u01b0\u1ee3c index ch\u01b0a\ncurl http://localhost:9200/products/_search?pretty\n\n# Xem s\u1ed1 l\u01b0\u1ee3ng documents\ncurl http://localhost:9200/products/_count\n"})}),"\n",(0,r.jsx)(e.h3,{id:"43-test-trong-nestjs",children:"4.3. Test trong NestJS"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsxs)(e.strong,{children:["File ",(0,r.jsx)(e.code,{children:"src/health/health.controller.ts"}),":"]})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-typescript",children:"import { Controller, Get } from '@nestjs/common';\nimport { ElasticsearchService } from '@nestjs/elasticsearch';\n\n@Controller('health')\nexport class HealthController {\n  constructor(private readonly es: ElasticsearchService) {}\n\n  @Get('elasticsearch')\n  async check() {\n    try {\n      const health = await this.es.cluster.health();\n      return { status: 'ok', health };\n    } catch (error) {\n      return { status: 'error', message: error.message };\n    }\n  }\n}\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"5-workflow-t\u1ed5ng-quan",children:"5. Workflow t\u1ed5ng quan"}),"\n",(0,r.jsx)(e.h3,{id:"lu\u1ed3ng-d\u1eef-li\u1ec7u-t\u1eeb-postgresql--elasticsearch--kibana",children:"Lu\u1ed3ng d\u1eef li\u1ec7u t\u1eeb PostgreSQL \u2192 Elasticsearch \u2192 Kibana"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"PostgreSQL (products table)\n         \u2193\n    Logstash (\u0111\u1ed3ng b\u1ed9 m\u1ed7i 30s)\n         \u2193\n    Elasticsearch (index: products)\n         \u2193\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2193                             \u2193\n  Kibana                    NestJS API\n  (xem tr\u1ef1c quan)          (search, filter)\n"})}),"\n",(0,r.jsx)(e.h3,{id:"c\xe1c-b\u01b0\u1edbc-tri\u1ec3n-khai-nhanh",children:"C\xe1c b\u01b0\u1edbc tri\u1ec3n khai nhanh"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Setup ELK Stack"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"docker-compose up -d\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"T\u1ea1o c\u1ea5u tr\xfac th\u01b0 m\u1ee5c Logstash"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"mkdir -p logstash/{config,pipeline,drivers,templates}\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Download JDBC driver"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"cd logstash/drivers\nwget https://jdbc.postgresql.org/download/postgresql-42.7.1.jar\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"T\u1ea1o c\xe1c file c\u1ea5u h\xecnh"})," (nh\u01b0 \u0111\xe3 h\u01b0\u1edbng d\u1eabn \u1edf tr\xean)"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Kh\u1edfi \u0111\u1ed9ng l\u1ea1i Logstash"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"docker-compose restart logstash\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Ki\u1ec3m tra d\u1eef li\u1ec7u"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"curl http://localhost:9200/products/_search?pretty\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"T\u1ea1o Index Pattern tr\xean Kibana"})," (",(0,r.jsx)(e.a,{href:"http://localhost:5601",children:"http://localhost:5601"}),")"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"T\xedch h\u1ee3p v\xe0o NestJS"})," v\xe0 s\u1eed d\u1ee5ng!"]}),"\n"]}),"\n"]})]})}function d(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(h,{...n})}):h(n)}},8453:(n,e,s)=>{s.d(e,{R:()=>l,x:()=>c});var t=s(6540);const r={},i=t.createContext(r);function l(n){const e=t.useContext(i);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:l(n.components),t.createElement(i.Provider,{value:e},n.children)}}}]);