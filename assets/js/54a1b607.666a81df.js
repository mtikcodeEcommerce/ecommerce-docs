"use strict";(globalThis.webpackChunkecommerce_docs=globalThis.webpackChunkecommerce_docs||[]).push([[89],{2423:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>d,frontMatter:()=>a,metadata:()=>c,toc:()=>o});const c=JSON.parse('{"id":"SetupElasticsearch","title":"H\u01b0\u1edbng d\u1eabn c\xe0i \u0111\u1eb7t v\xe0 tri\u1ec3n khai ELK Stack v\u1edbi NestJS","description":"1. C\xe0i \u0111\u1eb7t ELK Stack b\u1eb1ng Docker","source":"@site/docs/SetupElasticsearch.md","sourceDirName":".","slug":"/SetupElasticsearch","permalink":"/ecommerce-docs/docs/SetupElasticsearch","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Setup Authorization","permalink":"/ecommerce-docs/docs/SetupAuth"}}');var t=s(4848),i=s(8453);const a={},l="H\u01b0\u1edbng d\u1eabn c\xe0i \u0111\u1eb7t v\xe0 tri\u1ec3n khai ELK Stack v\u1edbi NestJS",r={},o=[{value:"1. C\xe0i \u0111\u1eb7t ELK Stack b\u1eb1ng Docker",id:"1-c\xe0i-\u0111\u1eb7t-elk-stack-b\u1eb1ng-docker",level:2},{value:"1.1. Y\xeau c\u1ea7u h\u1ec7 th\u1ed1ng",id:"11-y\xeau-c\u1ea7u-h\u1ec7-th\u1ed1ng",level:3},{value:"1.2. T\u1ea1o file docker-compose.yml",id:"12-t\u1ea1o-file-docker-composeyml",level:3},{value:"1.3. C\u1ea5u h\xecnh Logstash",id:"13-c\u1ea5u-h\xecnh-logstash",level:3},{value:"1.4. Kh\u1edfi ch\u1ea1y ELK Stack",id:"14-kh\u1edfi-ch\u1ea1y-elk-stack",level:3},{value:"1.5. Ki\u1ec3m tra k\u1ebft n\u1ed1i",id:"15-ki\u1ec3m-tra-k\u1ebft-n\u1ed1i",level:3},{value:"2. T\xedch h\u1ee3p Elasticsearch v\xe0o NestJS",id:"2-t\xedch-h\u1ee3p-elasticsearch-v\xe0o-nestjs",level:2},{value:"2.1. C\xe0i \u0111\u1eb7t c\xe1c package c\u1ea7n thi\u1ebft",id:"21-c\xe0i-\u0111\u1eb7t-c\xe1c-package-c\u1ea7n-thi\u1ebft",level:3},{value:"2.2. C\u1ea5u h\xecnh Elasticsearch Module",id:"22-c\u1ea5u-h\xecnh-elasticsearch-module",level:3},{value:"2.3. T\u1ea1o Elasticsearch Module",id:"23-t\u1ea1o-elasticsearch-module",level:3},{value:"3. C\u1ea5u h\xecnh v\xe0 s\u1eed d\u1ee5ng Kibana",id:"3-c\u1ea5u-h\xecnh-v\xe0-s\u1eed-d\u1ee5ng-kibana",level:2},{value:"4. Testing v\xe0 Debugging",id:"4-testing-v\xe0-debugging",level:2},{value:"4.1. Test k\u1ebft n\u1ed1i Elasticsearch",id:"41-test-k\u1ebft-n\u1ed1i-elasticsearch",level:3},{value:"4.2. Test Logstash",id:"42-test-logstash",level:3}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"h\u01b0\u1edbng-d\u1eabn-c\xe0i-\u0111\u1eb7t-v\xe0-tri\u1ec3n-khai-elk-stack-v\u1edbi-nestjs",children:"H\u01b0\u1edbng d\u1eabn c\xe0i \u0111\u1eb7t v\xe0 tri\u1ec3n khai ELK Stack v\u1edbi NestJS"})}),"\n",(0,t.jsx)(n.h2,{id:"1-c\xe0i-\u0111\u1eb7t-elk-stack-b\u1eb1ng-docker",children:"1. C\xe0i \u0111\u1eb7t ELK Stack b\u1eb1ng Docker"}),"\n",(0,t.jsx)(n.h3,{id:"11-y\xeau-c\u1ea7u-h\u1ec7-th\u1ed1ng",children:"1.1. Y\xeau c\u1ea7u h\u1ec7 th\u1ed1ng"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Docker v\xe0 Docker Compose \u0111\xe3 \u0111\u01b0\u1ee3c c\xe0i \u0111\u1eb7t"}),"\n",(0,t.jsx)(n.li,{children:"\xcdt nh\u1ea5t 4GB RAM kh\u1ea3 d\u1ee5ng cho Docker"}),"\n",(0,t.jsx)(n.li,{children:"Docker Desktop (Windows/Mac) ho\u1eb7c Docker Engine (Linux)"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"12-t\u1ea1o-file-docker-composeyml",children:"1.2. T\u1ea1o file docker-compose.yml"}),"\n",(0,t.jsxs)(n.p,{children:["T\u1ea1o file ",(0,t.jsx)(n.code,{children:"docker-compose.yml"})," trong th\u01b0 m\u1ee5c g\u1ed1c c\u1ee7a d\u1ef1 \xe1n:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'version: \'3.8\'\n\nservices:\n  # Elasticsearch\n  elasticsearch:\n    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0\n    container_name: elasticsearch\n    environment:\n      - discovery.type=single-node\n      - ES_JAVA_OPTS=-Xms512m -Xmx512m\n      - xpack.security.enabled=false\n      - xpack.security.enrollment.enabled=false\n    ports:\n      - "9200:9200"\n      - "9300:9300"\n    volumes:\n      - elasticsearch_data:/usr/share/elasticsearch/data\n    networks:\n      - elk\n    healthcheck:\n      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]\n      interval: 30s\n      timeout: 10s\n      retries: 5\n\n  # Logstash\n  logstash:\n    image: docker.elastic.co/logstash/logstash:8.11.0\n    container_name: logstash\n    volumes:\n      - ./logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml:ro\n      - ./logstash/pipeline:/usr/share/logstash/pipeline:ro\n    ports:\n      - "5000:5000/tcp"\n      - "5000:5000/udp"\n      - "9600:9600"\n    environment:\n      - LS_JAVA_OPTS=-Xms256m -Xmx256m\n    networks:\n      - elk\n    depends_on:\n      elasticsearch:\n        condition: service_healthy\n\n  # Kibana\n  kibana:\n    image: docker.elastic.co/kibana/kibana:8.11.0\n    container_name: kibana\n    ports:\n      - "5601:5601"\n    environment:\n      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200\n      - ELASTICSEARCH_URL=http://elasticsearch:9200\n    networks:\n      - elk\n    depends_on:\n      elasticsearch:\n        condition: service_healthy\n\nnetworks:\n  elk:\n    driver: bridge\n\nvolumes:\n  elasticsearch_data:\n    driver: local\n'})}),"\n",(0,t.jsx)(n.h3,{id:"13-c\u1ea5u-h\xecnh-logstash",children:"1.3. C\u1ea5u h\xecnh Logstash"}),"\n",(0,t.jsx)(n.p,{children:"T\u1ea1o c\u1ea5u tr\xfac th\u01b0 m\u1ee5c cho Logstash:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"logstash/\n\u251c\u2500\u2500 config/\n\u2502   \u2514\u2500\u2500 logstash.yml\n\u2514\u2500\u2500 pipeline/\n    \u2514\u2500\u2500 logstash.conf\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:["File ",(0,t.jsx)(n.code,{children:"logstash/config/logstash.yml"}),":"]})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'http.host: "0.0.0.0"\nxpack.monitoring.elasticsearch.hosts: [ "http://elasticsearch:9200" ]\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:["File ",(0,t.jsx)(n.code,{children:"logstash/pipeline/logstash.conf"}),":"]})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-conf",children:'input {\n  tcp {\n    port => 5000\n    codec => json\n  }\n  udp {\n    port => 5000\n    codec => json\n  }\n}\n\nfilter {\n  # Th\xeam timestamp n\u1ebfu ch\u01b0a c\xf3\n  if ![timestamp] {\n    mutate {\n      add_field => { "timestamp" => "%{@timestamp}" }\n    }\n  }\n\n  # Parse JSON n\u1ebfu message l\xe0 string\n  if [message] =~ /^\\{.*\\}$/ {\n    json {\n      source => "message"\n      target => "parsed"\n    }\n  }\n\n  # Th\xeam c\xe1c field t\xf9y ch\u1ec9nh\n  mutate {\n    add_field => {\n      "service" => "nestjs-app"\n    }\n  }\n}\n\noutput {\n  elasticsearch {\n    hosts => ["http://elasticsearch:9200"]\n    index => "nestjs-logs-%{+YYYY.MM.dd}"\n  }\n\n  # \u0110\u1ec3 debug, c\xf3 th\u1ec3 b\u1eadt stdout\n  stdout {\n    codec => rubydebug\n  }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"14-kh\u1edfi-ch\u1ea1y-elk-stack",children:"1.4. Kh\u1edfi ch\u1ea1y ELK Stack"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Kh\u1edfi \u0111\u1ed9ng t\u1ea5t c\u1ea3 services\ndocker-compose up -d\n\n# Ki\u1ec3m tra tr\u1ea1ng th\xe1i\ndocker-compose ps\n\n# Xem logs\ndocker-compose logs -f\n"})}),"\n",(0,t.jsx)(n.h3,{id:"15-ki\u1ec3m-tra-k\u1ebft-n\u1ed1i",children:"1.5. Ki\u1ec3m tra k\u1ebft n\u1ed1i"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Elasticsearch"}),": ",(0,t.jsx)(n.a,{href:"http://localhost:9200",children:"http://localhost:9200"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Kibana"}),": ",(0,t.jsx)(n.a,{href:"http://localhost:5601",children:"http://localhost:5601"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Logstash"}),": TCP/UDP port 5000"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Ki\u1ec3m tra Elasticsearch:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"curl http://localhost:9200\n"})}),"\n",(0,t.jsx)(n.p,{children:"K\u1ebft qu\u1ea3 mong \u0111\u1ee3i:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "name" : "...",\n  "cluster_name" : "docker-cluster",\n  "version" : {\n    "number" : "8.11.0",\n    ...\n  }\n}\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"2-t\xedch-h\u1ee3p-elasticsearch-v\xe0o-nestjs",children:"2. T\xedch h\u1ee3p Elasticsearch v\xe0o NestJS"}),"\n",(0,t.jsx)(n.h3,{id:"21-c\xe0i-\u0111\u1eb7t-c\xe1c-package-c\u1ea7n-thi\u1ebft",children:"2.1. C\xe0i \u0111\u1eb7t c\xe1c package c\u1ea7n thi\u1ebft"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"npm install @nestjs/elasticsearch @elastic/elasticsearch\nnpm install -D @types/node\n"})}),"\n",(0,t.jsx)(n.h3,{id:"22-c\u1ea5u-h\xecnh-elasticsearch-module",children:"2.2. C\u1ea5u h\xecnh Elasticsearch Module"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:["File ",(0,t.jsx)(n.code,{children:".env"}),":"]})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-env",children:"# Elasticsearch Configuration\nELASTICSEARCH_NODE=http://localhost:9200\nELASTICSEARCH_INDEX_PREFIX=nestjs\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:["File ",(0,t.jsx)(n.code,{children:"src/config/elasticsearch.config.ts"}),":"]})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { registerAs } from '@nestjs/config';\n\nexport default registerAs('elasticsearch', () => ({\n  node: process.env.ELASTICSEARCH_NODE || 'http://localhost:9200',\n  indexPrefix: process.env.ELASTICSEARCH_INDEX_PREFIX || 'nestjs',\n}));\n"})}),"\n",(0,t.jsx)(n.h3,{id:"23-t\u1ea1o-elasticsearch-module",children:"2.3. T\u1ea1o Elasticsearch Module"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:["File ",(0,t.jsx)(n.code,{children:"src/elasticsearch/elasticsearch.module.ts"}),":"]})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { Module } from '@nestjs/common';\nimport { ElasticsearchModule as NestElasticsearchModule } from '@nestjs/elasticsearch';\nimport { ConfigModule, ConfigService } from '@nestjs/config';\nimport { ElasticsearchService } from './elasticsearch.service';\n\n@Module({\n  imports: [\n    NestElasticsearchModule.registerAsync({\n      imports: [ConfigModule],\n      useFactory: async (configService: ConfigService) => ({\n        node: configService.get('elasticsearch.node'),\n        maxRetries: 10,\n        requestTimeout: 60000,\n        pingTimeout: 60000,\n      }),\n      inject: [ConfigService],\n    }),\n  ],\n  providers: [ElasticsearchService],\n  exports: [ElasticsearchService],\n})\nexport class ElasticsearchModule {}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"3-c\u1ea5u-h\xecnh-v\xe0-s\u1eed-d\u1ee5ng-kibana",children:"3. C\u1ea5u h\xecnh v\xe0 s\u1eed d\u1ee5ng Kibana"}),"\n",(0,t.jsx)(n.h2,{id:"4-testing-v\xe0-debugging",children:"4. Testing v\xe0 Debugging"}),"\n",(0,t.jsx)(n.h3,{id:"41-test-k\u1ebft-n\u1ed1i-elasticsearch",children:"4.1. Test k\u1ebft n\u1ed1i Elasticsearch"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Ki\u1ec3m tra health\ncurl http://localhost:9200/_cluster/health?pretty\n\n# Ki\u1ec3m tra c\xe1c indices\ncurl http://localhost:9200/_cat/indices?v\n\n# Xem d\u1eef li\u1ec7u trong index\ncurl http://localhost:9200/nestjs-products/_search?pretty\n"})}),"\n",(0,t.jsx)(n.h3,{id:"42-test-logstash",children:"4.2. Test Logstash"}),"\n",(0,t.jsx)(n.p,{children:"G\u1eedi test message \u0111\u1ebfn Logstash:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Linux/Mac\necho \'{"message":"test log","level":"info"}\' | nc localhost 5000\n\n# Windows (PowerShell)\n\'{"message":"test log","level":"info"}\' | Out-File -Encoding ASCII temp.json\nGet-Content temp.json | & "C:\\path\\to\\nc.exe" localhost 5000\n'})})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>l});var c=s(6540);const t={},i=c.createContext(t);function a(e){const n=c.useContext(i);return c.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),c.createElement(i.Provider,{value:n},e.children)}}}]);